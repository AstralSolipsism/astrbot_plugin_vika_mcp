# AstrBot 维格表MCP插件 v3.0

一个基于MCP（Model-Controller-Plugin）架构的**智能化**维格表集成插件，支持**自动发现数据表**，大模型通过自然语言自动调用维格表操作功能，真正的零配置使用体验。

## 🚀 v0.9 重大更新

### 🎯 智能化核心功能
- 🔍 **自动发现数据表**: 无需手动配置表ID，插件自动扫描并缓存所有数据表
- 🏢 **多空间站支持**: 自动识别和管理多个维格表空间站
- 🧠 **智能表名匹配**: 支持模糊匹配、别名映射、自定义简称
- ⚡ **智能缓存**: 自动缓存数据表信息，大幅提升响应速度
- 🆕 **一键创建表**: 支持通过自然语言创建新的数据表

### 📈 用户体验升级
- 🎯 **零配置体验**: 只需提供API Token，其他全部自动化
- 💬 **自然语言操作**: "帮我看看员工表"、"创建一个项目管理表"
- 📊 **实时状态**: 完整的连接状态、同步状态、配置信息展示
- 🔧 **智能运维**: 自动检测配置问题，提供解决建议

## 功能特性

- 🤖 **智能交互**: 支持大模型自动调用，用户只需用自然语言描述需求
- 🔍 **自动发现**: 智能扫描空间站，自动发现并缓存所有数据表
- 🌐 **灵活部署**: 支持官方维格表和自建维格表服务器
- 📊 **完整CRUD**: 支持数据的查询、添加、更新、删除操作
- 🔍 **智能搜索**: 支持跨字段的智能搜索功能
- 📋 **表格管理**: 创建、删除、查看数据表和字段信息
- 🏷️ **智能别名**: 支持模糊匹配、自定义别名、简短名称
- ⚡ **异步处理**: 高性能异步架构，不阻塞机器人响应
- 💾 **智能缓存**: 自动缓存机制，减少API调用，提升响应速度

## 安装与配置

### 1. 安装插件

将插件文件夹放置到 AstrBot 的插件目录中。

### 2. 最简配置（推荐）

**新用户只需配置API Token即可！**插件会自动发现您的数据表：

```yaml
vika_mcp_plugin:
  vika_api_token: "ustk_your_api_token_here"      # 必需：维格表 API Token
  vika_host: "https://api.vika.cn"                # 必需：维格表服务器地址
  # 其他配置都有合理默认值，插件会自动发现数据表！
```

### 3. 高级配置（可选）

如需个性化配置，可添加以下参数：

```yaml
vika_mcp_plugin:
  vika_api_token: "ustk_your_api_token_here"      # 必需：维格表 API Token
  vika_host: "https://api.vika.cn"                # 必需：维格表服务器地址
  
  # 智能化配置
  auto_sync_on_startup: true                      # 启动时自动同步数据表
  default_space_id: "spc1234567890abcdef"         # 默认空间站（多空间站时推荐）
  cache_duration_hours: 24                        # 缓存有效期（单位为小时）
  
  # 自定义别名（让长表名有简短别名）
  custom_aliases:
    "员工": "员工信息管理表"
    "项目": "项目管理跟踪表"
    
  # 显示配置
  max_records_display: 20                         # 最大显示记录数
  enable_auto_type_conversion: true               # 启用自动类型转换
```

### 3. 获取配置信息

#### API Token
1. 登录维格表官网或自建服务器
2. 进入用户中心
3. 生成 API Token
4. 复制 Token 到配置文件中

#### 数据表 ID
1. 打开要操作的维格表
2. 在浏览器地址栏中找到数据表 ID（通常是 dst 开头的字符串）
3. 复制 ID 到配置文件中

#### 自建服务器配置
如果使用自建的维格表服务器，请将 `vika_host` 修改为您的服务器地址，例如：
```yaml
vika_host: "https://vika.your-domain.com"
```

## 使用方式

### MCP模式交互

插件采用MCP架构，用户无需记住复杂指令，只需用自然语言描述需求即可：

#### 查询数据
```
用户：帮我看看员工表里有哪些人
AI：[自动调用get_vika_records工具]

用户：查询项目表中状态为进行中的项目
AI：[自动调用get_vika_records工具，带过滤条件]

用户：显示客户表的前5条记录
AI：[自动调用get_vika_records工具，限制记录数]
```

#### 添加数据
```
用户：在员工表中添加一个新员工，姓名是张三，部门是技术部，工号是1001
AI：[自动调用add_vika_record工具]

用户：给项目表加一个项目：项目名称=新功能开发，负责人=李四，状态=规划中
AI：[自动调用add_vika_record工具]
```

#### 搜索数据
```
用户：在员工表中搜索技术部的员工
AI：[自动调用search_vika_records工具]

用户：找找项目表里有没有李四负责的项目
AI：[自动调用search_vika_records工具]
```

#### 更新数据
```
用户：把员工表中记录ID为rec123456的员工部门改为市场部
AI：[自动调用update_vika_record工具]
```

#### 删除数据
```
用户：删除项目表中的记录rec789012
AI：[自动调用delete_vika_record工具]
```

#### 获取表结构
```
用户：看看员工表有哪些字段
AI：[自动调用get_vika_fields工具]

用户：检查一下维格表插件的连接状态
AI：[自动调用get_vika_status工具]
```

## MCP工具列表

插件提供以下MCP工具供大模型调用：

### 🎯 智能化工具（v3.0新增）
| 工具名称 | 功能描述 | 主要参数 |
|---------|----------|----------|
| `sync_vika_datasheets` | **智能同步数据表** | 无参数 |
| `list_vika_spaces` | **列出空间站** | 无参数 |
| `list_vika_datasheets` | **列出数据表** | filter_keyword |
| `create_vika_datasheet` | **创建数据表** | name, description, fields_config |

### 📊 数据操作工具
| 工具名称 | 功能描述 | 主要参数 |
|---------|----------|----------|
| `get_vika_records` | 获取表格记录 | datasheet_name, view_name, filter_formula, max_records |
| `add_vika_record` | 添加新记录 | datasheet_name, record_data |
| `search_vika_records` | 搜索记录 | datasheet_name, search_query, search_fields |
| `update_vika_record` | 更新记录 | datasheet_name, record_id, update_data |
| `delete_vika_record` | 删除记录 | datasheet_name, record_id |

### 🔧 管理工具
| 工具名称 | 功能描述 | 主要参数 |
|---------|----------|----------|
| `get_vika_fields` | 获取字段信息 | datasheet_name |
| `get_vika_status` | 检查插件状态 | 无参数 |

## 高级功能

### 1. 数据表别名

通过配置别名，可以用更友好的名称引用数据表：

```yaml
datasheet_mapping:
  "员工管理": "dst1234567890abcdef"
  "项目跟踪": "dst0987654321fedcba"
```

用户可以直接说"查询员工管理表"而不需要记住复杂的ID。

### 2. 过滤查询

支持使用维格表的公式语法进行复杂查询：

```
用户：查询员工表中部门是技术部且工作年限大于3年的员工
AI：[使用filter_formula参数进行精确过滤]
```

### 3. 灵活的数据格式

支持多种数据输入格式：

- JSON格式：`{"姓名":"张三","年龄":25,"已婚":true}`
- 键值对格式：`姓名=张三,年龄=25,已婚=true`

### 4. 自动类型转换

插件会自动识别和转换数据类型：
- 数字字符串 → 整数/浮点数
- "true"/"false" → 布尔值
- 其他 → 字符串

## 错误处理

插件具有完善的错误处理机制：

- **配置错误**: 自动检测并提示配置问题
- **网络错误**: 友好的网络连接错误提示
- **权限错误**: 清晰的权限不足提示
- **数据错误**: 详细的数据格式错误说明

## 性能优化

- **异步处理**: 所有操作都在后台线程执行，不影响机器人响应
- **连接复用**: 客户端连接复用，减少初始化开销
- **记录限制**: 自动限制返回记录数，避免过大响应

## 安全考虑

- **配置验证**: 启动时自动验证配置完整性
- **权限控制**: 基于API Token的权限控制
- **数据验证**: 输入数据自动验证和清理

## 故障排除

### 常见问题

1. **连接失败**
   - 检查API Token是否正确
   - 验证服务器地址是否可访问
   - 确认网络连接正常

2. **找不到数据表**
   - 检查数据表ID是否正确
   - 验证别名映射配置
   - 确认权限是否足够

3. **添加记录失败**
   - 检查字段名是否存在
   - 验证数据类型是否匹配
   - 确认必填字段已提供


## 技术支持

如有问题或建议：

1. 查看插件日志获取详细错误信息
2. 检查维格表API文档确认参数格式
3. 确保网络连接正常且API Token有效
4. 验证数据表权限设置
